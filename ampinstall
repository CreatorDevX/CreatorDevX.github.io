#!/bin/bash
#CubeCoders AMP Installer (C)2019-2024 CubeCoders Limited

function isPresent { command -v "$1" &> /dev/null && echo 1; }
function isFileOpen { lsof "$1" &> /dev/null && echo 1; }
function fetchString { if [ -n "$CURL_IS_PRESENT" ]; then curl --ipv4 -s "$1" 2>/dev/null; else wget --inet4-only -qO- "$1" 2>/dev/null; fi }
function urlLink { echo -e "\e]8;;${1}\a${2:-${1}}\e]8;;\a"; }
function prnt { echo -e "$1" | fold -s -w "$cols"; }
function check_version { local distro; distro=$(echo "$1" | tr '[:upper:]' '[:lower:]'); [[ "$distro" == "$(echo "$ID" | tr '[:upper:]' '[:lower:]')" && "$(printf '%s\n' "$3" "$2" | sort -V | head -n1)" != "$3" ]] && echo "AMP reqiures $1 $3 or newer. You are currently running $VERSION_ID. Please upgrade to $1 $3 and try again." && exit 1; }

echo "Please wait while GetAMP examines your system and network configuration..."

PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
ARCH=$(arch 2> /dev/null || uname -m)
AMP_SYS_USER=amp
GETAMP_VERSION="3.0.6"

if [ -z "$AMP_ADS_PORT" ]; then AMP_ADS_PORT="8080"; fi
if [ -z "$AMP_ADS_IP" ]; then AMP_ADS_IP="0.0.0.0"; fi
if [ -z "$DNS_SERVER" ]; then DNS_SERVER="8.8.8.8"; fi

echo " - Checking installed packages..."
AMP_USER_EXISTS=$(grep -c :/home/$AMP_SYS_USER: /etc/passwd)
AMPINSTMGR_IS_INSTALLED="$(isPresent ampinstmgr)"
#NFT_IS_PRESENT="$(isPresent nft)"
IPTABLES_IS_PRESENT="$(isPresent iptables)"
UFW_IS_PRESENT="$(isPresent ufw)"
FIREWALLCMD_IS_PRESENT="$(isPresent firewall-cmd)"
SS_IS_PRESENT="$(isPresent ss)"
CURL_IS_PRESENT="$(isPresent curl)"
DIG_IS_PRESENT="$(isPresent dig)"
USERADD_IS_PRESENT="$(isPresent useradd)"
TPUT_IS_PRESENT="$(isPresent tput)"
SELINUX_IS_INSTALLED="$(isPresent setsebool)"
DOCKER_IS_INSTALLED="$(isPresent docker)"
APT_IS_PRESENT="$(isPresent apt-get)"
YUM_IS_PRESENT="$(isPresent yum)"
PACMAN_IS_PRESENT="$(isPresent pacman)"
JQ_IS_PRESENT="$(isPresent jq)"
IP_IS_PRESENT="$(isPresent ip)"
#SNAP_IS_PRESENT="$(isPresent snap)"
STATUS_FILE=/opt/cubecoders/amp/shared/WebRoot/installState.json
JAVA_PACKAGE="temurin-8-jdk temurin-17-jdk temurin-20-jdk"

echo " - Checking environment..."
if [[ $EUID -ne 0 ]]; then
	echo "You need root access to run this script! Try running '${BoldText}sudo su${NormalText}' as a separate command first."
	echo "${BoldText}Do not just run the same command again with 'sudo' in front!${NormalText}"
	exit 40
fi

if [ ! "$USERADD_IS_PRESENT" ]; then
	echo "The useradd command isn't available in the current environment. It's missing from \$PATH"
	echo "Try running 'sudo -i' and trying again. Do not re-run the same command with 'sudo' in front."
	exit 130
fi

if [ ! "$TPUT_IS_PRESENT" ]; then
	echo "The tput command isn't available in the current environment. It's missing from \$PATH"
	echo "This usually means you're using an unsupported Linux distribution."
	exit 132
fi

LOG_FILE="$HOME/getamp-$(date +%Y%m%d-%H%M%S).log"
INSTALL_SUMMARY=~/ampsummary.log
date > "$LOG_FILE"

BoldText=$(tput bold 2> /dev/null)
NormalText=$(tput sgr0 2> /dev/null)
UnderlineText=$(tput smul 2> /dev/null)
cols="$(tput cols 2> /dev/null)" || cols=80

if [ "$UFW_IS_PRESENT" ]; then
	UFWSTATUS=$(ufw status)

	if [ "$UFWSTATUS" == "*inactive*" ]; then
		echo "${BoldText}Warning: 'ufw' is installed, but it is not the systems default firewall.${NormalText}"
		echo "AMP will revert to another firewall, but if you change this down the line you may"
		echo "need to manually add/update firewall rules."
		unset UFW_IS_PRESENT
	fi
fi

FIREWALL=none
if [ "$UFW_IS_PRESENT" ]; then FIREWALL=ufw;
elif [ "$FIREWALLCMD_IS_PRESENT" ]; then FIREWALL=firewalld;
elif [ "$IPTABLES_IS_PRESENT" ]; then FIREWALL=iptables; 
fi
# elif [ "$NFT_IS_PRESENT" ]; then FIREWALL=nft; fi; //Disabled for now

echo " - Checking network configuration..."

if [ "$IP_IS_PRESENT" ]; then
	read -r _{,} GATEWAY_IP _ _ _ INTERNAL_IP _ < <(ip r g 1.0.0.0)
else
	INTERNAL_IP=$(hostname -I | cut -f 1 -d ' ')
fi

if [ "$SS_IS_PRESENT" ]; then
	NS_COMMAND=ss
else
	NS_COMMAND=netstat
fi

if [ "$APT_IS_PRESENT" ]; then
	export DEBIAN_FRONTEND=noninteractive
	PM_COMMAND=apt-get
	PM_INSTALL=(install -y)
	PM_UNINSTALL=(remove -y)
	CERTBOT_PACKAGE=python3-certbot-nginx
	LIB32_PACKAGES="lib32stdc++6 lib32z1 libncurses5:i386 libbz2-1.0:i386 libtinfo5:i386 libcurl3-gnutls:i386 libsdl2-2.0-0:i386"
	PREREQ_PACKAGES="dirmngr software-properties-common apt-transport-https gpg-agent dnsutils jq git unzip wget gpg qrencode"
	PM_LOCK_FILE="/var/lib/dpkg/lock"
	INSTALL_IN_PROGRESS=$(isFileOpen $PM_LOCK_FILE)

	if [ "$FIREWALL" == "iptables" ] && [ ! -d /etc/iptables ]; then
		PREREQ_PACKAGES="$PREREQ_PACKAGES iptables-persistent"
	fi
elif [ "$YUM_IS_PRESENT" ]; then
	PM_COMMAND=yum
	PM_INSTALL=(-y install)
	PM_UNINSTALL=(-y remove)
	LIB32_PACKAGES="glibc.i686 libstdc++.i686 ncurses-libs.i686"
	PREREQ_PACKAGES="wget tmux socat unzip git bind-utils tar jq qrencode"
	CERTBOT_PACKAGE=python3-certbot-nginx
	PM_LOCK_FILE="/var/run/yum.pid"
	INSTALL_IN_PROGRESS=$(isFileOpen $PM_LOCK_FILE)
elif [ "$PACMAN_IS_PRESENT" ]; then
	PM_COMMAND=pacman
	PM_INSTALL=(-S --noconfirm)
	LIB32_PACKAGES="lib32-glibc lib32-gcc-libs"
	PREREQ_PACKAGES="wget tmux socat unzip git dnsutils tar jq qrencode"
	CERTBOT_PACKAGE=certbot-nginx
	JAVA_PACKAGE="jre8-openjdk-headless jre-openjdk-headless"

	if [ "$ARCH" != "x86_64" ]; then
		echo "AMP only supports aarch64 on Debian and Red Hat/CentOS based distros at this time."
		exit
	fi
else
	echo "This system doesn't appear to be supported. No supported package manager (apt/yum/pacman) was found."
	echo "Automated installation is only availble for Debian, Red-Hat and Arch based distrubitions, including Ubuntu and CentOS."
	echo "$NAME is not a supported distribution at this time."
	exit
fi

if [ "$ID" == "photon" ]; then
	PREREQ_PACKAGES="wget tmux socat unzip git bindutils tar jq sqlite-devel"
	FORCE_DOCKER=1
fi

if [ "$INSTALL_IN_PROGRESS" ]; then
	echo "Your package manager is currently performing another installation."
	echo "Please wait for that to finish before installing AMP."
	echo
	echo "Info: A lock is open on $PM_LOCK_FILE"
	exit 131
fi

EXTERNAL_IP=$(fetchString "https://api.ipify.org/")

# Check if EXTERNAL_IP is either empty or doesn't look like a valid IP address

if [[ -z "$EXTERNAL_IP" || ! "$EXTERNAL_IP" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?$|^([a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}$ ]]; then
  # Try another provider
  EXTERNAL_IP=$(fetchString "https://ipecho.io/plain")
fi

echo " - Detecting network type..."

export EXTERNAL_IP
NETWORK_TYPE=$([[ "$INTERNAL_IP" == "$EXTERNAL_IP" ]] && echo "Direct" || echo "NAT")
NETWORK_TYPE=$(traceroute -m 4 google.com 2> /dev/null | grep -ic " 100.64." >/dev/null && echo "CGNAT" || echo "$NETWORK_TYPE")
export NETWORK_TYPE

syspass=
ampuser=
amppass=

if [ ! -f /etc/os-release ]; then
	echo "No OS info available. Missing /etc/os-release"
	exit 20
fi

if ! [[ "$LANG" =~ ^.+\.(UTF-8|utf8)$ ]] && [ -z "$SKIPLOCALECHECK" ]; then
	echo "System locale is not a UTF-8 compatible locale, it is currently $LANG"
	echo "Please update your system locale to a UTF-8 one and reboot before running this script."
	if [ "$APT_IS_PRESENT" ]; then
		prnt "You can do this by running 'dpkg-reconfigure locales && locale-gen' as root and making sure a UTF-8 locale for your region/language is selected. On some systems it may be 'update-locale LANG=en_GB.utf8' instead."
	else
		prnt "Please consult your distributions documentation for how to configure your system for a UTF-8 compatible locale."
	fi
	echo "It may be necessary to log out and log in again for locale changes to take effect."
	exit 30
fi

export TERM=xterm

# shellcheck disable=1091
source /etc/os-release

check_version "Ubuntu" "20.04"
check_version "Debian" "10"
check_version "CentOS" "8"

if [ "$ARCH" != "x86_64" ] && [ "$ARCH" != "aarch64" ]; then
	echo "AMP is only supported on x86_64 and aarch64 systems. You are running $ARCH"
	exit 64
fi

if [ "$ARCH" == "aarch64" ]; then
	reposuffix=$ARCH/
	echo
	echo "Platform information"
	echo
	echo "You are installing AMP on an aarch64 system."
	echo
	prnt "This means that many game servers will not run on this system, or may only run via CPx2 emulation which may significantly reduce performance."
	echo 
	echo "For more information on aarch64 compatible titles, please see:"
	urlLink "https://discourse.cubecoders.com/docs?topic=1870&utm_term=aarch64"
	echo
	read -n 1 -s -r -p "Press any key to continue."
fi

if [ "$(mount | grep -icE '^tmpfs\s+\/tmp\s+.*?noexec.+$')" -gt 0 ]; then
	echo "Your /tmp filesystem has the 'noexec' flag set. Please edit your /etc/fstab file to not have the noexec flag on /tmp"
	echo "You will need to reboot your system after making this change"
	exit 120
fi

if [ -f /var/run/scw-metadata.cache ]; then
	CLOUD_PROVIDER=Scaleway
	EXT_HOSTNAME=$(grep -oP '^ID=\K.+$' /var/run/scw-metadata.cache).pub.cloud.scaleway.com
else
	if [ "$(grep -ic ovh /etc/resolv.conf)" -gt 0 ]; then CLOUD_PROVIDER=OVH;
	elif [ "$(grep -ic hetzner /var/run/cloud-init/instance-data.json &> /dev/null || echo 0)" -gt 0 ]; then CLOUD_PROVIDER="Hetzner";
	elif [ "$(grep -ic linode /etc/resolv.conf)" -gt 0 ]; then CLOUD_PROVIDER="Linode";
	elif [ "$(grep -ic oracle /etc/resolv.conf)" -gt 0 ]; then CLOUD_PROVIDER="Oracle";
	elif [ "$(grep -ic ec2 /etc/resolv.conf)" -gt 0 ]; then CLOUD_PROVIDER="Amazon";
	elif [ -f /var/run/cloud-init/cloud-id-azure ]; then CLOUD_PROVIDER="Azure";
	elif [ -f /etc/cloud/digitalocean.info ]; then CLOUD_PROVIDER="DigitalOcean"; fi

	if [ "$DIG_IS_PRESENT" ]; then
		FQDN=$(hostname -f)
		if [ "$FQDN" != "localhost" ]; then
			fqdnip=$(dig "$DNS_SERVER" +short "$FQDN" | tail -n 1)

			if [ "$fqdnip" == "$EXTERNAL_IP" ]; then
				EXT_HOSTNAME=$FQDN
			fi
		fi

		if [ -z "$EXT_HOSTNAME" ]; then
			digout=$(dig "$DNS_SERVER" +short -x "$EXTERNAL_IP" | tail -n 1)
			if [ -n "$digout" ]; then
				reverse="${digout::-1}"
				verify=$(dig "$DNS_SERVER" +short "$digout" | tail -n 1)

				if [ "$verify" == "$EXTERNAL_IP" ]; then
					EXT_HOSTNAME=$reverse
				fi
			fi
		fi
	elif [[ "$FQDN" =~ ^.+?(\..+)+$ ]]; then
		EXT_HOSTNAME=$FQDN
	fi

	if [ "$CLOUD_PROVIDER" == "Oracle" ] && [ -z "$USE_ANSWERS" ]; then
		echo
		echo "GetAMP has detected that you are using Oracle Cloud."
		echo
		prnt "Extra steps are required to run AMP on Oracle Cloud, if you have not yet done this, ${BoldText}press CTRL+C now to stop the setup${NormalText} and consult the documentation at ${UnderlineText}$(urlLink "https://support.cubecoders.com/docs?topic=2307&utm_term=oracle")${NormalText} before continuing."
		echo
		prnt "Make sure you are using ${BoldText}Ubuntu 22.04 or newer${NormalText} as per the guide. Older versions are not supported on ARM hardware."
		echo
		read -n 1 -s -r -p "Press any key to continue if you have already done this."
	fi
fi

export EXT_HOSTNAME

function showSystemInfo {
	echo "Distribution        : $ID $VERSION_ID"
	echo "Platform            : $ARCH"
	if [ -z "$PRIVATE" ]; then
		echo "Internal IP address : $INTERNAL_IP"
		echo "External IP address : $EXTERNAL_IP"
		if [ "$NETWORK_TYPE" == "NAT" ] && [ -n "$GATEWAY_IP" ]; then echo "Gateway IP address  : $GATEWAY_IP"; fi
	fi
	echo "Network type        : $NETWORK_TYPE"
	echo "Detected Firewall   : $FIREWALL"
	if [ -n "$EXT_HOSTNAME" ]; then echo "External Host name  : $EXT_HOSTNAME"; fi
	if [ -n "$CLOUD_PROVIDER" ]; then echo "Service Provider    : $CLOUD_PROVIDER"; fi
	echo "System Locale       : $LANG"
	echo "Package Manager	    : $PM_COMMAND"
}

function configureDarkMagicNew {
	if [ "$ARCH" != "aarch64" ]; then
		echo "CPx2 is only applicable to aarch64 systems."
		exit
	fi

	if [ "$ID" != "ubuntu" ] && [ "$ID" != "debian" ]; then
		echo "CPx2 is only supported on Ubuntu and Debian at this time."
		exit
	fi

	oldpwd=$(pwd)
	
	echo "Installing CPx2..."
	echo " - Configuring package manager and installing dependencies..."
	{
	dpkg --add-architecture armhf
	$PM_COMMAND update
	$PM_COMMAND "${PM_INSTALL[@]}" git build-essential cmake libsdl2-dev libsdl2-2.0-0 gcc-arm-linux-gnueabihf libc6:armhf libncurses5:armhf libstdc++6:armhf
	} &>> "$LOG_FILE"
	cd ~ || return
	echo " - Fetching sources..."
	{
	git clone --depth=1 https://github.com/ptitSeb/box86
	git clone --depth=1 https://github.com/ptitSeb/box64
	} &>> "$LOG_FILE"
	echo " - Compiling 32-bit x86 support... (This may take a while)"
	{
		mkdir ~/box86/build;
		cd ~/box86/build || return;
		cmake .. -DRPI4ARM64=1 -DCMAKE_BUILD_TYPE=RelWithDebInfo;
		make "-j$(nproc)";
		make install;
	} &>> "$LOG_FILE"
	echo " - Compiling x86_64 support... (This may take a while)"
	{
		mkdir ~/box64/build;
		cd ~/box64/build || return;
		cmake .. -DRPI4ARM64=1 -DCMAKE_BUILD_TYPE=RelWithDebInfo;
		make "-j$(nproc)";
		make install;
	} &>> "$LOG_FILE"
	echo " - Restarting system services..."
	systemctl restart systemd-binfmt &>> "$LOG_FILE"
	rm -r ~/box86 ~/box64
	cd "$oldpwd" || return
	echo " - Done!"
}

function showWelcome {
	if [ -z "$USE_ANSWERS" ]; then
		clear
		echo
		echo "GetAMP v$GETAMP_VERSION"
		prnt "AMP QuickStart installation script for Debian, Red-Hat and Arch based GNU/Linux distributions"
		prnt "This installer will perform the following:"
		echo 
		echo " * Install any pending system updates"
		echo " * Install any prerequisites and dependencies via your systems package manager"
		echo " * Add the CubeCoders repository to your system to keep AMP updated"
		echo " * Install AMP and create a default management instance on port $AMP_ADS_PORT"
		echo " * Create any firewalls necessary to allow you to connect to AMP"
		echo " * Configure the default AMP instance to start on boot"
		echo 
		echo "Press CTRL+C to cancel installation."
		echo
		prnt "It is safe to cancel this installation at any point. You can run the install script again, and the script will skip any steps it has already completed."
		echo
	fi
	showSystemInfo
	echo
}

function promptForSystemUser {
	if [ -n "$USE_ANSWERS" ]; then
		syspass=$ANSWER_SYSPASSWORD
		return
	fi

	syspass=$(cat /proc/sys/kernel/random/uuid)
}

function promptForAMPUser {
	if [ -n "$USE_ANSWERS" ]; then
		ampuser=$ANSWER_AMPUSER
		amppass=$ANSWER_AMPPASS
		return
	fi

	echo "Enter new login details for use with AMP."
	echo "These are the login details you will use to log into AMPs web interface."
	echo
	read -rp "Username [admin]: " ampuser
	ampuser=${ampuser:-admin}
	read -rsp "Password: " amppass
	if [ -z "$amppass" ]; then
		echo "You must provide a password for the AMP login user."
		exit 60
	fi
	echo
	read -rsp "Confirm Password:" amppassconfirm
	echo
	echo

	if [ "$syspass" == "$amppass" ]; then
		echo "The system and AMP passwords cannot be the same. Aborting."
		exit 70
	fi

	if [ "$amppass" != "$amppassconfirm" ]; then
		echo "Confirmation password does not match. Aborting."
		exit 80
	fi

	amppass=base64:$(echo -n "$amppass" | base64)
	ampuser=$(printf '%q' "$ampuser")
}

function promptForDeps {
	if [ -n "$FORCE_DOCKER" ]; then
		installDocker=y
		return; 
	fi

	if [ -n "$USE_ANSWERS" ]; then
		installJava=$ANSWER_INSTALLJAVA
		installsrcdsLibs=$ANSWER_INSTALLSRCDSLIBS
		installDocker=$ANSWER_INSTALLDOCKER
		return
	fi

	if [ "$ARCH" == "x86_64" ]; then
		echo "Would you like to isolate your AMP instances by running them inside Docker containers?"
		prnt "This provides an additional layer of protection at the expense of a minor performance impact. It is strongly recommended if you are going to allow untrusted users access to AMP."
		echo
		prnt "Docker is also used to allow more applications to run without requiring extra dependencies on the host system, such as Wine for Windows-based applications."
		read -n1 -rp "[y/N] " installDocker
		installDocker=${installDocker:-n}
		echo
		echo
	fi

	echo "Will you be running Minecraft servers on this installation?"
	echo "If selected, this installs the required versions of Java."
	read -n1 -rp "[Y/n] " installJava
	installJava=${installJava:-y}
	echo
	echo

	if [ "$ARCH" == "x86_64" ]; then
		echo "Will you be running applications that rely on SteamCMD? (Rust, Ark, CSGO, TF2, etc) on this installation?"
		echo "If selected, this will install the required additional 32-bit libraries."
		read -n1 -rp "[Y/n] " installsrcdsLibs
		installsrcdsLibs=${installsrcdsLibs:-y}
		echo
		echo
	fi

	if [ "$ARCH" == "aarch64" ] && { [ "$ID" == "ubuntu" ] || [ "$ID" == "debian" ]; }; then
		echo "Would you like to configure this system for cross-platform execution (CPx2)?"
		prnt "This allows AMP to run a limited number of x86_64 applications on aarch64 systems via emulation. But this comes at a significant performance impact."
		echo
		read -n1 -rp "[y/N] " installDarkMagic
		installDarkMagic=${installDarkMagic:-n}
		echo
		echo
	fi
}

function promptForHTTPS {
	if [ -n "$USE_ANSWERS" ]; then
		setupnginx=Y
		nginxdomain=$EXT_HOSTNAME
		nginxemail=$ANSWER_EMAIL
		return
	fi

	apache_is_present=$(isPresent apache2)

	echo "Would you like AMP to be configured for use with HTTPS?"
	if ! [ "$apache_is_present" ]; then
		echo 
		prnt "This will install nginx on your system and requires that you do not use any other web servers such as Apache on this system."
	fi
	echo
	prnt "If nginx is already set up, this will add a new site configuration for AMP and will not modify any existing configurations. Otherwise, nginx will be installed."
	echo
	echo "This will also create firewall rules to open ports 80 (HTTP) and 443 (HTTPS)"
	if [ "$SELINUX_IS_INSTALLED" ]; then
		echo "and the appropriate selinux rules to allow nginx to act as a reverse proxy."
	fi
	echo "You also must own a domain name that resolves to ${BoldText}$EXTERNAL_IP${NormalText} (Your external IP)"
	if [ -n "$EXT_HOSTNAME" ]; then
		echo
		echo "GetAMP has automatically detected an externally resolvable domain of $EXT_HOSTNAME"
		echo "You can either use this or you can supply your own subdomain at the next step."
	fi
	echo
	echo "${BoldText}Do not choose this option if you do not already own a domain.${NormalText}"
	echo 
	prnt "Using this facility requires that you read and accept the LetsEncrypt terms at ${UnderlineText}$(urlLink "https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf")${NormalText}"
	echo
	echo "Enable HTTPS?"
	read -n1 -rp "[y/N] " setupnginx
	echo
	echo

	if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
		AMP_ADS_IP="127.0.0.1"
		if [ "$apache_is_present" ]; then
			echo "Apache2 is installed, which will conflict with nginx as required for AMPs reverse proxy - Aborting."
			echo "Either remove Apache2 and try again, or re-run this script and select 'No' when asked if you wish to use HTTPS"
			exit 90
		fi

		echo "Please specify which domain you wish to use."
		echo "${BoldText}You should use a subdomain that is only going to be used for AMP.${NormalText}"
		echo "E.g. ${BoldText}amp.mydomain.com${NormalText}"

		if [ -n "$EXT_HOSTNAME" ]; then
			read -rp "Domain [$EXT_HOSTNAME]: " nginxdomain
			nginxdomain=${nginxdomain:-$EXT_HOSTNAME}
		else
			read -rp "Domain: " nginxdomain
		fi

		if [ -z "$nginxdomain" ]; then
			echo "Using HTTPS requires that you specify a domain. Do not select this option if you don't have one."
			exit 91
		fi

		echo "Please enter your email address (Optional)"
		echo "LetsEncrypt will send important certificate notifications here."
		read -rp "Email: " nginxemail

		if [ "$NETWORK_TYPE" == "NAT" ]; then
			echo "GetAMP has detected that you are currently behind a NAT."
			echo "Please forward ports 80 and 443 TCP to $INTERNAL_IP if you have not already done so."
			read -n 1 -s -r -p "Press any key to continue once you have done this."
		fi
	fi
}

function createUser {
	echo "Creating system user..."
	
	if ! useradd -G tty -d /home/"$AMP_SYS_USER" -m "$AMP_SYS_USER" -s /bin/bash &>> "$LOG_FILE"; then
		echo "Failed to add system user. Aborting..."
		promptLogUpload
		exit 11
	fi
	echo "$AMP_SYS_USER:$syspass" | chpasswd
	{
		echo "export TERM=xterm"
		# shellcheck disable=2028
		echo 'export PS1=" \[\e[30;41m\]î°\[\e[m\]\[\e[37;41m\] CubeCoders AMP \[\e[m\]\[\e[31;44m\]î°\[\e[m\]\[\e[44m\] ð»\u\[\e[m\]\[\e[44m\]@\[\e[m\]\[\e[44m\]\h \[\e[m\]\[\e[34;42m\]î°\[\e[m\]\[\e[30;42m\] ð\w \[\e[m\]\[\e[32;40m\]î°\[\e[m\] "'
		# shellcheck disable=2028
		echo "alias sudo=\"echo \\\"You cannot use sudo while logged in as the 'amp' user, you need to be logged in as an administrator/root user do to that.\\\" && false\""
		echo "alias htop=\"htop -u $AMP_SYS_USER\""
	} >> /home/$AMP_SYS_USER/.profile
	mkdir -p "/home/$AMP_SYS_USER/.config/htop/"
	cat <<EOF > /home/$AMP_SYS_USER/.config/htop/htoprc
# Beware! This file is rewritten by htop when settings are changed in the interface.
# The parser is also very primitive, and not human-friendly.
fields=0 48 111 38 46 47 49 1
sort_key=46
sort_direction=1
hide_threads=1
hide_kernel_threads=1
hide_userland_threads=1
shadow_other_users=1
show_thread_names=0
show_program_path=1
highlight_base_name=1
highlight_megabytes=1
highlight_threads=1
tree_view=1
header_margin=1
detailed_cpu_time=0
cpu_count_from_zero=1
update_process_names=0
account_guest_in_cpu_meter=0
color_scheme=4
delay=15
left_meters=LeftCPUs2 Memory Swap Clock
left_meter_modes=1 1 1
right_meters=RightCPUs2 Tasks LoadAverage Uptime
right_meter_modes=1 2 2 2
EOF
	chown $AMP_SYS_USER:$AMP_SYS_USER "/home/$AMP_SYS_USER/.profile" 2> /dev/null
	chown -R $AMP_SYS_USER:$AMP_SYS_USER "/home/$AMP_SYS_USER/.config" 2> /dev/null
	if [ "$ID" == "photon" ]; then
		chown -R $AMP_SYS_USER:users "/home/$AMP_SYS_USER/.config" 2> /dev/null
	fi
}

function updateSystem {
	echo "Updating System..."
	if [ "$APT_IS_PRESENT" ]; then
		apt-get update &>> "$LOG_FILE"
		apt-get upgrade -y &>> "$LOG_FILE"
	elif [ "$YUM_IS_PRESENT" ]; then
		yum update -y &>> "$LOG_FILE"
	elif [ "$PACMAN_IS_PRESENT" ]; then
		sed -i "/\[multilib\]/,/Include/"'s/^#//' /etc/pacman.conf
		pacman -Syu --noconfirm &>> "$LOG_FILE"
	fi
}

function installJava {
	if [ "$APT_IS_PRESENT" ]; then
	{
		echo Adding Adoptium APT repository...
		wget -qO- https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor > /usr/share/keyrings/adoptium.gpg
		echo "deb [signed-by=/usr/share/keyrings/adoptium.gpg] https://packages.adoptium.net/artifactory/deb $VERSION_CODENAME main" | tee /etc/apt/sources.list.d/adoptium.list
		apt-get update;
	} &>> "$LOG_FILE"
	elif [ "$YUM_IS_PRESENT" ]; then
		if [[ "$ID" == "almalinux" ]]; then
			echo "Distro is AlmaLinux, Pretending to be RHEL instead."
			ID="rhel"
		fi

		# Check if the version contains a dot
		if [[ $VERSION_ID == *.* ]]; then
		  # Extract the major part of the version before the dot
		  VERSION_ID=${VERSION_ID%%.*}
		fi

		if [[ ! "$ID" =~ ^(amazonlinux|centos|fedora|opensuse|oraclelinux|rhel|rocky|sles)$ ]]; then
			echo "The distribution $ID is not supported by Adoptium. Please install Java manually."
			return
		fi

		echo Adding Adoptium RPM repository...
		
		$PM_COMMAND install -y epel-release &>> "$LOG_FILE"
		yum repolist &>> "$LOG_FILE"
		BASEURL=https://packages.adoptium.net/artifactory/rpm/$ID/$VERSION_ID/$(arch)

		if wget --spider "$BASEURL" >/dev/null 2>&1; then
			cat <<EOF > /etc/yum.repos.d/adoptium.repo
[Adoptium]
name=Adoptium
baseurl=$BASEURL
enabled=1
gpgcheck=1
gpgkey=https://packages.adoptium.net/artifactory/api/gpg/key/public
EOF
			yum check-update &>> "$LOG_FILE"
		else
			echo "Java could not be installed automatically for your distribution. Please install it manually after setup completes."
			echo
			read -n 1 -s -r -p "Press any key to continue."
		fi
	fi

	echo "Installing Java for Minecraft..."
# shellcheck disable=SC2086
	$PM_COMMAND "${PM_INSTALL[@]}" $JAVA_PACKAGE &>> "$LOG_FILE"
}

function installDocker {
	if [ "$DOCKER_IS_INSTALLED" ]; then
		echo "Docker already installed. Skipping..."
		{
			usermod -a -G docker $AMP_SYS_USER
			systemctl enable docker
			systemctl start docker
		} &>> "$LOG_FILE"
		return
	fi

	if [ "$ARCH" != "x86_64" ]; then
		echo "AMP's docker mode is only supported on x86_64 systems. You are running $ARCH"
		exit 64
	fi

	echo "Installing Docker..."

	if [ "$APT_IS_PRESENT" ]; then
		wget -qO- "https://download.docker.com/linux/$ID/gpg" | gpg --dearmor > /usr/share/keyrings/download.docker.com.gpg
		echo "deb [signed-by=/usr/share/keyrings/download.docker.com.gpg arch=amd64] https://download.docker.com/linux/$ID $(lsb_release -cs) stable" > /etc/apt/sources.list.d/download.docker.com.list
		apt-get update &>> "$LOG_FILE"
	elif [ "$YUM_IS_PRESENT" ]; then
		wget -P /etc/yum.repos.d https://download.docker.com/linux/centos/docker-ce.repo &>> "$LOG_FILE"
		yum check-update &>> "$LOG_FILE"
	fi

	{
		$PM_COMMAND "${PM_INSTALL[@]}" docker-ce docker-ce-cli containerd.io
		systemctl enable docker
		systemctl start docker
		usermod -a -G docker $AMP_SYS_USER
	} &>> "$LOG_FILE"
}

function installSrcdsDeps {
	echo "Installing 32-bit dependencies for srcds..."
	if [ "$APT_IS_PRESENT" ]; then
		dpkg --add-architecture i386 &>> "$LOG_FILE"
		apt-get update &>> "$LOG_FILE"
	fi

# shellcheck disable=SC2086
	$PM_COMMAND "${PM_INSTALL[@]}" $LIB32_PACKAGES &>> "$LOG_FILE"
}

function installNginx {
	echo "Installing nginx and certbot..."

	if [ "$YUM_IS_PRESENT" ]; then
		$PM_COMMAND install -y epel-release &>> "$LOG_FILE"
		yum repolist &>> "$LOG_FILE"
	fi
			
	if [ "$APT_IS_PRESENT" ] && [ "$ID" == "ubuntu" ] ; then
		add-apt-repository --yes universe
		apt-get update
	fi

	$PM_COMMAND "${PM_INSTALL[@]}" certbot $CERTBOT_PACKAGE &>> "$LOG_FILE"
	
	CERTBOT_IS_PRESENT=$(isPresent certbot)
	if ! [ "$CERTBOT_IS_PRESENT" ]; then
		wget -P /usr/local/bin https://dl.eff.org/certbot-auto &>> "$LOG_FILE"
		chmod +x /usr/local/bin/certbot-auto
	fi

	$PM_COMMAND "${PM_INSTALL[@]}" nginx &>> "$LOG_FILE"
	systemctl enable nginx &>> "$LOG_FILE"
	PROVISIONFLAGS="$PROVISIONFLAGS +Core.Webserver.UsingReverseProxy True"

	if [ "$SELINUX_IS_INSTALLED" ]; then
		echo "Updating SELinux rules (httpd relay)..."
		setsebool -P httpd_can_network_relay 1
		setsebool -P httpd_can_network_connect 1
	fi
}

function installDependencies {
	echo Installing prerequisites...

# shellcheck disable=SC2086
	$PM_COMMAND "${PM_INSTALL[@]}" $PREREQ_PACKAGES &>> "$LOG_FILE"

	JQ_IS_PRESENT="$(isPresent jq)"

	if [[ "$installDocker" =~ ^[Yy]$ ]]; then
		installDocker
		PROVISIONFLAGS="$PROVISIONFLAGS +ADSModule.Defaults.UseDocker True"
		installJava=n
		installsrcdsLibs=n
	fi

	if [[ "$installJava" =~ ^[Yy]$ ]]; then
		installJava
	fi

	if [[ "$installsrcdsLibs" =~ ^[Yy]$ ]]; then
		installSrcdsDeps
	fi

	if [[ "$installDarkMagic" =~ ^[Yy]$ ]]; then
		configureDarkMagicNew
	fi

	if [ -n "$SKIP_INSTALL" ]; then
		setupnginx=n;
		return
	fi	

	if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
		installNginx
	fi
}

function checkConfig {
	if [[ "$setupnginx" =~ ^[Yy]$ ]] && [[ -n "$SKIPDOMAINCHECK" ]]; then
		echo -n "Checking settings... "
		domainip=$(dig "$DNS_SERVER" +short "$nginxdomain" | tail -1)

		if [ "$domainip" != "$EXTERNAL_IP" ]; then
			echo "Bad domain configuration."
			if [ -z "$domainip" ]; then
				echo "The specified domain $nginxdomain could not be resolved."
				echo "If you've only recently created the domain or record"
			else
				echo "The specified domain $nginxdomain resolves to '$domainip' but your external IP is '$EXTERNAL_IP'."
				echo "If you've recently changed the IP address this domain resolves to"
			fi
			echo "you may need to empty your DNS cache or wait for DNS propogation to complete."
			echo "Aborting setup. You can re-run this setup to try again."

			exit 100
		else
			echo "Domain $nginxdomain resolves correctly to $domainip."
		fi
	fi
}

function addRepo {
	if [ "$APT_IS_PRESENT" ]; then
		echo "Adding CubeCoders DEB repository..."
		mkdir -p /usr/share/keyrings
		echo "deb [signed-by=/usr/share/keyrings/repo.cubecoders.com.gpg] https://repo.cubecoders.com/$reposuffix debian/" > /etc/apt/sources.list.d/repo.cubecoders.com.list
		{ 
			wget -O /usr/share/keyrings/repo.cubecoders.com.gpg https://repo.cubecoders.com/archive.key;
			apt-get update 
		} &>> "$LOG_FILE"
	elif [ "$YUM_IS_PRESENT" ]; then
		echo "Adding CubeCoders RPM repository..."
		wget -P /etc/yum.repos.d "https://repo.cubecoders.com/${reposuffix}CubeCoders.repo" &>> "$LOG_FILE"
		yum check-update &>> "$LOG_FILE"
	fi
}

function updateRepo {
	addRepo
}

function installAMP {
	echo "Installing instance manager..."
	
	if [ "$APT_IS_PRESENT" ] || [ "$YUM_IS_PRESENT" ] ; then
		echo " - Installing via package manager..."
		if ! $PM_COMMAND "${PM_INSTALL[@]}" ampinstmgr &>> "$LOG_FILE"; then
			echo "Failed to install instance manager. Aborting..."
			prnt "Possible causes for this are an unsupported distribution, or the repository being in the middle of a sync. In which case wait 30 minutes and try again, re-running the same installation command."
			
			promptLogUpload

			exit 12
		fi
	elif [ "$PACMAN_IS_PRESENT" ]; then
		echo " - Installing from tgz archive..."
		wget -q https://repo.cubecoders.com/ampinstmgr-latest.tgz &>> "$LOG_FILE"
		tar -xf ampinstmgr-latest.tgz -C / &>> "$LOG_FILE"
		rm ampinstmgr-latest.tgz
	fi
}

function addFirewallRule {
	echo "Adding firewall rule for port $1 ($2) via $FIREWALL..."
	case "$FIREWALL" in
		none) echo "No firewall installed, please add port $1 manually to your inbound firewall" ;;
		ufw) ufw allow from any to any port "$1" proto tcp comment "$2" ;;
		firewalld) firewall-cmd "--add-port=$1/tcp" --permanent && firewall-cmd --reload ;;
		iptables) iptables -A INPUT -p tcp -m tcp --dport "$1" -j ACCEPT -m comment --comment "$2" && iptables-save > /etc/iptables/rules.v4 ;;
		nft) nft add rule filter input tcp dport "$1" accept comment "\"$2\"" ;;
		*) echo "Unsupported Firewall!" ;;
	esac
}

function updateFirewall {
	echo Adding firewall rules...
	if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
		addFirewallRule 443 'AMP Reverse Proxy'
		addFirewallRule 80 'AMP Reverse Proxy'
	else
		addFirewallRule "$AMP_ADS_PORT" 'AMP Management Instance'
	fi
}

function configureNginx {
	echo "{\"status\":200}" > $STATUS_FILE
	
	if ! ampinstmgr setupnginx "$nginxdomain" "$AMP_ADS_PORT" "$nginxemail"; then
		echo "Failed to configure nginx. Please check $LOG_FILE . Aborting..."
		
		promptLogUpload

		exit 19
	fi
}

function createDefaultInstance {
	if [ -n "$SKIP_INSTALL" ]; then
		return
	fi

	if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
		configureNginx
	fi

	echo "Creating default instance..."
	
	if su -l $AMP_SYS_USER -c "EXTERNAL_IP=$EXTERNAL_IP EXT_HOSTNAME=$nginxdomain ampinstmgr quick $ampuser \"$amppass\" $AMP_ADS_IP $AMP_ADS_PORT $PROVISIONFLAGS"; then
		systemctl enable ampinstmgr.service
		systemctl enable ampfirewall.service
		systemctl enable ampfirewall.timer
		systemctl enable amptasks.service
		systemctl enable amptasks.timer
		systemctl start ampfirewall.timer
		systemctl start amptasks.timer
	else
		echo "Failed to create default instance."

		if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
			echo "Removing generated nginx config..."
			rm "/etc/nginx/conf.d/$nginxdomain.conf" &>> "$LOG_FILE"
		fi

		echo "Aborting..."

		promptLogUpload

		exit 110
	fi
}

function checkPortAvailable {
	local lines
	lines=$($NS_COMMAND -lnt | grep -c "$AMP_ADS_PORT")
	return "$lines"
}

function getNextFreePort {
	while ! checkPortAvailable; do
		AMP_ADS_PORT=$((AMP_ADS_PORT+1))
	done
}

function postSetupHTTPS {
	if ! [ "$AMPINSTMGR_IS_INSTALLED" ]; then
		echo "AMP is not yet installed on this system. Aborting..."
		exit
	fi

	promptForHTTPS
	if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
		checkConfig
		existingInstance=$(su -l $AMP_SYS_USER -c "ampinstmgr status" | grep "ADS" | cut -f 1 -d ' ')
		existingPort=$(su -l $AMP_SYS_USER -c "ampinstmgr status" | grep "ADS" | grep -E -o "[0-9]{4,5}")
		su -l $AMP_SYS_USER -c "ampinstmgr stop $existingInstance"
		su -l $AMP_SYS_USER -c "ampinstmgr rebind $existingInstance 127.0.0.1 $existingPort"
		su -l $AMP_SYS_USER -c "ampinstmgr reconfigure $existingInstance +Core.Webserver.UsingReverseProxy True +ADSModule.Defaults.DefaultAuthServerURL 'http://localhost:$existingPort/'"
		su -l $AMP_SYS_USER -c "ampinstmgr reconfiguremultiple \* +Core.Login.AuthServerURL 'http://localhost:$existingPort/'"
		installNginx
		updateFirewall
		configureNginx
		su -l $AMP_SYS_USER -c "ampinstmgr start $existingInstance"
		cleanup
		echo "Done!"
	fi
}

function update {
	echo "Applying AMP updates..."

	if [ "$APT_IS_PRESENT" ] || [ "$YUM_IS_PRESENT" ] ; then
		$PM_COMMAND update
		$PM_COMMAND "${PM_INSTALL[@]}" ampinstmgr
	elif [ "$PACMAN_IS_PRESENT" ]; then
		installAMP
	fi

	echo "Updating AMP instances..."
	su -l $AMP_SYS_USER -c "ampinstmgr upgradeall"

	echo "Done!"
}

function cleanup {
	rm -f $STATUS_FILE 2> /dev/null
}

function promptLogUpload {
	if ! [ "$JQ_IS_PRESENT" ]; then
		echo "Something went wrong during the installation. GetAMP has saved an installation log at:"
		echo "$LOG_FILE"
		prnt "The log file may contain sensitive information such as username, any supplied domain names or your systems hostname so if in doubt - check the file manually before sharing it."
		return
	fi

	echo
	echo "Something went wrong during the installation. Would you like to upload your setup log for easy sharing?"
	echo "This will upload $LOG_FILE to the hastebin service and give you a URL you can share."
	echo
	prnt "The log file may contain sensitive information such as username, any supplied domain names or your systems hostname so if in doubt - check the file manually and upload it yourself."
	read -n1 -rp "[y/N] " uploadlog
	uploadlog=${uploadlog:-n}

	if [[ "$uploadlog" =~ ^[Yy]$ ]]; then
		PASTE_KEY=$(curl -H "content-type: text/plain" -X POST https://www.toptal.com/developers/hastebin/documents --data-binary "@$LOG_FILE" 2> /dev/null | jq -r .key 2> /dev/null)
		if [ -z "$PASTE_KEY" ]; then
			echo "Failed to upload log file. Please check $LOG_FILE manually."
		else
			URL="https://hastebin.com/$PASTE_KEY"
			echo "Log file uploaded successfully. You can view it at:"
			urlLink "$URL"
		fi
	fi
}

function paste {
	if ! [ "$JQ_IS_PRESENT" ]; then
		echo "'jq' isn't present. Unable to paste.'"
		return
	fi

	input=$(cat)
	echo "$input"
	PASTE_KEY=$(curl -H "content-type: text/plain" -X POST https://www.toptal.com/developers/hastebin/documents --data-binary "$input" 2> /dev/null | jq -r .key 2> /dev/null)
	if [ -z "$PASTE_KEY" ]; then
		echo "Failed to upload output."
	else
		URL="https://hastebin.com/$PASTE_KEY"
		echo "Output uploaded successfully. You can view it at:"
		urlLink "$URL"
	fi
}

function uninstall_notyettested {
	clear
	echo "UNTESTED CODE - COULD CAUSE TOTAL SYSTEM DATA DESTRUCTION - BACKUP FIRST!"
	echo
	echo
	echo "-- ${BoldText}PERMENENT DATA DESTRUCTION${NormalText} --"
	echo
	echo
	prnt "Uninstalling AMP will permemently and irreversibly destroy all applications managed by AMP on this system with no way to restore that data."
	echo
	echo "Some components such as Java, Docker and other 3rd party tools will not be removed"
	echo
	echo "Press CTRL+C to cancel."
	echo
	
	#Prompt for confirmation
	current_day=$(date -u +%A)
	phrase="I want to destroy all AMP data and the servers it manages. Today is ${current_day}."
	falsePhrase=${phrase// /Â }
	echo "Enter the following phrase to continue (You must type it, do not copy paste):"
	echo "${BoldText}${falsePhrase}${NormalText}"
	echo
	read -rp "Enter phrase: " userphrase
	echo

	if [[ "${userphrase}" == "${falsePhrase}" ]]; then
		echo "You copied and pasted the phrase. You must actually type it out."
		exit 1
	fi

	if [[ "${phrase}" != "${userphrase}" ]]; then
		echo "Bad confirmation. Please pay attention to case-sensitivity and punctuation."
		exit 1
	fi

	echo "Uninstalling AMP... No going back now!"
	{
	#Stop all instances
	su -l $AMP_SYS_USER -c "ampinstmgr stopall"
	killall -u $AMP_SYS_USER
	#Remove package
	$PM_COMMAND "${PM_UNINSTALL[@]}" ampinstmgr
	#Manually clean up /opt/cubecoders/amp
	rm -rf /opt/cubecoders/amp 2> /dev/null
	#Remove repositories
	rm /etc/apt/sources.list.d/repo.cubecoders.com.list 2> /dev/null
	rm /usr/share/keyrings/repo.cubecoders.com.gpg 2> /dev/null
	rm "/etc/yum.repos.d/${reposuffix}CubeCoders.repo" 2> /dev/null
	#Delete the AMP user and its home directory
	userdel -r $AMP_SYS_USER
	rm -rf "/home/${AMP_SYS_USER:?}"
	} &>> "$LOG_FILE"
	echo "Done!"
}

execute_func=""

for arg in "$@"; do
	case $arg in
		--private) PRIVATE=1 ;;
		--no-domain-verify) SKIPDOMAINCHECK=1 ;;
		--no-locale-verify) SKIPLOCALECHECK=1 ;;
		*)
			if ! type "$arg" &> /dev/null; then
				echo "No such function or flag: $arg"
				exit 1
			fi

			if [ -n "$execute_func" ]; then
				echo "Error: Multiple functions specified."
				exit 1
			fi

			execute_func="$arg"
			;;
	esac
done

if [ -n "$execute_func" ]; then
	$execute_func
	echo "Done"
	exit 0
fi


# ENTRY POINT
getNextFreePort
showWelcome

if [ "$AMP_USER_EXISTS" -eq "0" ]; then promptForSystemUser; fi

promptForAMPUser  
promptForDeps
promptForHTTPS

echo
echo "Installation Summary:" | tee $INSTALL_SUMMARY
echo | tee -a $INSTALL_SUMMARY
echo -en "AMP System user:\t\t" | tee -a $INSTALL_SUMMARY
if [ "$AMP_USER_EXISTS" -eq "0" ]; then echo "To be created"; else echo "Already exists"; fi | tee -a $INSTALL_SUMMARY
echo -en "Instance Manager:\t\t"| tee -a $INSTALL_SUMMARY
if [ "$AMPINSTMGR_IS_INSTALLED" ]; then echo "Already installed"; else echo "To be installed"; fi| tee -a $INSTALL_SUMMARY
echo -en "HTTPS setup:\t\t\t"| tee -a $INSTALL_SUMMARY
if [[ "$setupnginx" =~ ^[Yy]$ ]]; then echo "Yes, via nginx with domain $nginxdomain"; else echo "No"; fi| tee -a $INSTALL_SUMMARY
if [ "$ARCH" == "x86_64" ]; then
	echo -en "Install Docker:\t\t\t" | tee -a $INSTALL_SUMMARY
	if [[ "$installDocker" =~ ^[Yy]$ ]]; then echo "Yes"; else echo "No"; fi | tee -a $INSTALL_SUMMARY
	echo -en "Install 32-bit libraries:\t" | tee -a $INSTALL_SUMMARY
	if [[ "$installsrcdsLibs" =~ ^[Yy]$ ]]; then echo "Yes"; else echo "No"; fi | tee -a $INSTALL_SUMMARY
fi
echo -en "Install Java:\t\t\t"| tee -a $INSTALL_SUMMARY
if [[ "$installJava" =~ ^[Yy]$ ]]; then echo "Yes"; else echo "No"; fi | tee -a $INSTALL_SUMMARY
if [ "$ARCH" == "aarch64" ]; then
	echo -en "Configure CPx2:\t\t\t" | tee -a $INSTALL_SUMMARY
	if [[ "$installDarkMagic" =~ ^[Yy]$ ]]; then echo "Yes"; else echo "No"; fi | tee -a $INSTALL_SUMMARY
fi

if [ -z "$USE_ANSWERS" ]; then
	echo 
	echo "Ready to install AMP. Press ENTER to continue or CTRL+C to cancel."
	read -r
	echo
fi

echo Installing AMP...

if [ "$AMP_USER_EXISTS" -eq "0" ]; then
	createUser
else
	echo "$AMP_SYS_USER already exists. Skipping..."

	if [ "$AMPINSTMGR_IS_INSTALLED" ]; then
		if [ "$(su -l $AMP_SYS_USER -c 'ampinstmgr status | grep -c "â"')" -gt 1 ]; then
			echo "$AMP_SYS_USER already has instances. AMP appears to be already installed and configured. Aborting..."
			exit 135
		fi
	fi
fi

updateSystem
installDependencies
checkConfig

if ! [ "$AMPINSTMGR_IS_INSTALLED" ]; then
	addRepo
	installAMP
else
	echo "AMP instance manager already installed. Skipping..."
fi

updateFirewall
createDefaultInstance
cleanup

echo
echo "Installation complete. Thanks for using AMP!"
echo

if [[ "$setupnginx" =~ ^[Yy]$ ]]; then
	echo "You can now reach AMP at $(urlLink "https://$nginxdomain/")"
	echo
	echo "https://$nginxdomain/" | qrencode -t UTF8 -m 2 | sed -e "6s|$|	Scan this code or visit $(urlLink "https://$nginxdomain/")|" -e "7s|$|	to start using AMP from your mobile device.|"
	echo
elif [ "$INTERNAL_IP" == "$EXTERNAL_IP" ]; then
	echo "You can now reach AMP at $(urlLink "http://$INTERNAL_IP:$AMP_ADS_PORT/")"
	echo
	echo "http://$INTERNAL_IP:$AMP_ADS_PORT/" | qrencode -t UTF8 -m 2 | sed -e "6s|$|	Scan this code or visit $(urlLink "http://$INTERNAL_IP:$AMP_ADS_PORT/")|" -e "7s|$|	to start using AMP from your mobile device.|"
	echo
else
	echo "You can now reach AMP at $(urlLink "http://$INTERNAL_IP:$AMP_ADS_PORT/")"
	echo "or at $(urlLink "http://$EXTERNAL_IP:$AMP_ADS_PORT/")"
	echo
	echo "http://$INTERNAL_IP:$AMP_ADS_PORT/" | qrencode -t UTF8 -m 2 | sed -e "6s|$|	Scan this code or visit $(urlLink "http://$INTERNAL_IP:$AMP_ADS_PORT/")|" -e "7s|$|	to start using AMP from your mobile device.|" -e "8s|$|	(You must be connected to the same network as the server)|"
	echo
fi
